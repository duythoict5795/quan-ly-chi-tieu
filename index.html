<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản Lý Thu Chi Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; padding-bottom: 90px; }
        .nav-item.active { color: #4f46e5; }
        .nav-item.active svg { fill: #4f46e5; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .collapse-content { display: none; }
        .collapse-content.active { display: block; }
        .rotate-icon { transition: transform 0.3s; }
        .rotate-icon.active { transform: rotate(180deg); }
        .search-focus:focus-within {
            ring: 2px;
            ring-color: #4f46e5;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body>
    <header class="bg-white border-b sticky top-0 z-40 px-4 py-3 shadow-sm">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <h1 id="pageTitle" class="text-xl font-bold text-slate-800">Trang Chủ</h1>
            <div id="currentMonthDisplay" class="text-sm font-semibold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">Tháng --, ----</div>
        </div>
    </header>

    <main class="max-w-lg mx-auto px-4 py-6">
        <!-- TAB 1: TRANG CHỦ -->
        <section id="tab-home" class="tab-content active space-y-6">
            <div class="bg-gradient-to-br from-indigo-600 to-violet-700 rounded-3xl p-6 text-white shadow-xl">
                <p class="text-indigo-100 text-sm opacity-80">Số dư hiện tại</p>
                <h2 id="balanceDisplay" class="text-3xl font-bold mt-1">0 ₫</h2>
                <div class="flex justify-between mt-6 pt-4 border-t border-white/20">
                    <div>
                        <p class="text-[10px] text-indigo-100 uppercase font-bold tracking-wider">Thu tháng này</p>
                        <p id="incomeDisplay" class="font-bold text-lg">+ 0 ₫</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-indigo-100 uppercase font-bold tracking-wider">Chi tháng này</p>
                        <p id="expenseDisplay" class="font-bold text-lg">- 0 ₫</p>
                    </div>
                </div>
            </div>

            <!-- Form Thêm Giao Dịch -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-4 text-xs uppercase tracking-widest">Giao dịch mới</h3>
                <form id="transactionForm" class="space-y-4">
                    <div class="flex p-1 bg-slate-100 rounded-xl">
                        <label class="flex-1 text-center py-2 rounded-lg cursor-pointer transition has-[:checked]:bg-white has-[:checked]:shadow-sm has-[:checked]:text-emerald-600 font-bold text-slate-500 text-xs uppercase">
                            <input type="radio" name="type" value="income" class="hidden" onchange="updateCategorySelect()"> Thu nhập
                        </label>
                        <label class="flex-1 text-center py-2 rounded-lg cursor-pointer transition has-[:checked]:bg-white has-[:checked]:shadow-sm has-[:checked]:text-red-600 font-bold text-slate-500 text-xs uppercase">
                            <input type="radio" name="type" value="expense" class="hidden" checked onchange="updateCategorySelect()"> Chi tiêu
                        </label>
                    </div>

                    <div id="categoryContainer"></div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Số tiền (₫)</label>
                        <input type="text" id="amountDisplayInput" inputmode="numeric" placeholder="0" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 font-bold text-xl" oninput="formatCurrencyInput(this)" required>
                        <input type="hidden" id="amountInput">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ngày</label>
                            <input type="date" id="dateInput" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ghi chú</label>
                            <input type="text" id="noteInput" placeholder="" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition">Lưu giao dịch</button>
                </form>
            </div>

            <!-- Gần đây trên Home -->
            <div class="space-y-4">
                <div class="flex items-center justify-between px-1">
                    <h3 class="font-bold text-slate-800">Tháng này</h3>
                    <button onclick="switchTab('history', 'Lịch Sử')" class="text-[10px] font-bold text-indigo-600 uppercase">Xem tất cả</button>
                </div>
                <div id="homeRecentList" class="space-y-4"></div>
            </div>
        </section>

        <!-- TAB 2: PHÂN TÍCH -->
        <section id="tab-analysis" class="tab-content space-y-6">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-800">Chi tiêu theo nhóm</h3>
                    <input type="month" id="analysisMonthPicker" class="text-sm bg-slate-50 border-none rounded-lg p-2 focus:ring-indigo-500" onchange="updateAnalysis()">
                </div>
                <div class="relative h-64 mb-8">
                    <canvas id="financeChart"></canvas>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Tổng chi</span>
                        <span id="chartTotalValue" class="text-lg font-bold text-slate-800">0 ₫</span>
                    </div>
                </div>
                <div id="groupSummaryList" class="space-y-4"></div>
            </div>
        </section>

        <!-- TAB 3: LỊCH SỬ -->
        <section id="tab-history" class="tab-content space-y-4">
            <div class="sticky top-[60px] z-30 bg-[#f8fafc] py-2">
                <div class="relative flex items-center bg-white rounded-2xl shadow-sm border border-slate-100 px-4 search-focus transition-all duration-300">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm giao dịch..." class="w-full bg-transparent border-none py-3 px-3 text-sm focus:ring-0" oninput="handleSearch()">
                    <button id="clearSearchBtn" class="hidden text-slate-300 hover:text-slate-500" onclick="clearSearch()">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>
                    </button>
                </div>
            </div>

            <div id="historyTree" class="space-y-3"></div>
            <div id="searchResults" class="hidden space-y-3"></div>
        </section>

        <!-- TAB 4: CÀI ĐẶT -->
        <section id="tab-settings" class="tab-content space-y-6">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 space-y-6">
                <h3 class="font-bold text-slate-800 text-sm uppercase">Tùy chỉnh Danh mục</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between"><span class="text-xs font-bold text-emerald-600 uppercase">Thu nhập</span><button onclick="openAddCategoryModal('income')" class="text-xs bg-emerald-50 text-emerald-600 px-2 py-1 rounded-lg font-bold">+ Thêm</button></div>
                    <div id="settingsIncomeList" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="space-y-4 pt-4 border-t">
                    <div class="flex items-center justify-between"><span class="text-xs font-bold text-red-600 uppercase">Chi tiêu & Nhóm</span><button onclick="openAddGroupModal()" class="text-xs bg-red-50 text-red-600 px-2 py-1 rounded-lg font-bold">+ Nhóm mới</button></div>
                    <div id="settingsExpenseGroupsList" class="space-y-3"></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 text-sm uppercase mb-4">Dữ liệu</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportData()" class="flex flex-col items-center justify-center p-4 bg-blue-50 text-blue-600 rounded-2xl gap-2"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg><span class="text-[10px] font-bold uppercase">Sao lưu</span></button>
                    <button onclick="document.getElementById('importFile').click()" class="flex flex-col items-center justify-center p-4 bg-emerald-50 text-emerald-600 rounded-2xl gap-2"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg><span class="text-[10px] font-bold uppercase">Khôi phục</span></button>
                </div>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
                <button onclick="clearAllData()" class="w-full mt-3 py-3 text-red-500 text-[10px] font-bold uppercase tracking-widest bg-red-50 rounded-xl">Xóa sạch dữ liệu</button>
            </div>
        </section>
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t safe-area-bottom z-50">
        <div class="max-w-lg mx-auto flex justify-around py-3">
            <button onclick="switchTab('home', 'Trang Chủ')" class="nav-item active flex flex-col items-center gap-1 w-full" id="btn-home">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg>
                <span class="text-[9px] font-bold uppercase">Home</span>
            </button>
            <button onclick="switchTab('analysis', 'Phân Tích')" class="nav-item flex flex-col items-center gap-1 w-full" id="btn-analysis">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                <span class="text-[9px] font-bold uppercase">Chart</span>
            </button>
            <button onclick="switchTab('history', 'Lịch Sử')" class="nav-item flex flex-col items-center gap-1 w-full" id="btn-history">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
                <span class="text-[9px] font-bold uppercase">History</span>
            </button>
            <button onclick="switchTab('settings', 'Cài Đặt')" class="nav-item flex flex-col items-center gap-1 w-full" id="btn-settings">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                <span class="text-[9px] font-bold uppercase">Menu</span>
            </button>
        </div>
    </nav>

    <!-- Modal Overlay -->
    <div id="dialogOverlay" class="fixed inset-0 bg-black/40 hidden z-[100] items-center justify-center p-6 backdrop-blur-sm">
        <div id="dialogBox" class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl">
            <h3 id="dialogTitle" class="font-bold text-slate-800 mb-2"></h3>
            <div id="dialogBody" class="mb-6"></div>
            <div id="dialogActions" class="flex gap-2"></div>
        </div>
    </div>

    <script>
        const DB_KEY = 'finance_v2_final';
        const DEFAULT_STATE = {
            transactions: [],
            incomeCategories: ['Lương', 'Thưởng', 'Lãi tiết kiệm'],
            expenseGroups: [
                { id: 'g1', name: 'Ăn uống', color: '#f87171', categories: ['Ăn sáng', 'Ăn trưa', 'Ăn tối', 'Ăn vặt', 'Cà phê'] },
                { id: 'g2', name: 'Sinh hoạt', color: '#60a5fa', categories: ['Tiền điện', 'Tiền nước', 'Internet', 'Rác'] },
                { id: 'g3', name: 'Di chuyển', color: '#fbbf24', categories: ['Xăng xe', 'Gửi xe', 'Sửa xe'] },
                { id: 'g4', name: 'Khác', color: '#94a3b8', categories: ['Mua sắm', 'Phát sinh', 'Lặt vặt'] }
            ]
        };

        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let chartInstance = null;

        function saveState() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
            updateUI();
        }

        function loadState() {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) state = JSON.parse(stored);
            updateUI();
        }

        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function formatCurrencyInput(input) {
            // Loại bỏ tất cả ký tự không phải số
            let value = input.value.replace(/\D/g, "");
            
            // Lưu giá trị thực vào hidden input
            document.getElementById('amountInput').value = value;
            
            // Định dạng hiển thị với dấu chấm
            if (value === "") {
                input.value = "";
            } else {
                input.value = formatNumber(value);
            }
        }

        function switchTab(tabId, title) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`btn-${tabId}`).classList.add('active');
            document.getElementById('pageTitle').textContent = title;
            if (tabId === 'analysis') updateAnalysis();
            if (tabId === 'history') {
                clearSearch();
                renderHistoryTree();
            }
            if (tabId === 'settings') renderSettings();
            window.scrollTo(0, 0);
        }

        function updateUI() {
            const now = new Date();
            const curM = String(now.getMonth() + 1).padStart(2, '0');
            const curY = now.getFullYear();
            const curMonthStr = `${curY}-${curM}`;
            document.getElementById('currentMonthDisplay').textContent = `Tháng ${curM}, ${curY}`;

            let balance = 0, mIncome = 0, mExpense = 0;
            state.transactions.forEach(t => {
                const isThisMonth = t.date.startsWith(curMonthStr);
                if (t.type === 'income') {
                    balance += t.amount;
                    if (isThisMonth) mIncome += t.amount;
                } else {
                    balance -= t.amount;
                    if (isThisMonth) mExpense += t.amount;
                }
            });

            document.getElementById('balanceDisplay').textContent = formatVND(balance);
            document.getElementById('incomeDisplay').textContent = `+ ${formatVND(mIncome)}`;
            document.getElementById('expenseDisplay').textContent = `- ${formatVND(mExpense)}`;

            renderHomeRecent(curMonthStr);
            updateCategorySelect();
        }

        function handleSearch() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            const tree = document.getElementById('historyTree');
            const resultsDiv = document.getElementById('searchResults');
            const query = input.value.trim().toLowerCase();

            if (query === '') {
                clearBtn.classList.add('hidden');
                tree.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                return;
            }

            clearBtn.classList.remove('hidden');
            tree.classList.add('hidden');
            resultsDiv.classList.remove('hidden');

            const filtered = state.transactions.filter(t => 
                (t.note && t.note.toLowerCase().includes(query)) || 
                (t.category && t.category.toLowerCase().includes(query))
            ).sort((a,b) => b.date.localeCompare(a.date));

            if (filtered.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 text-center border border-slate-100">
                        <p class="text-slate-400 text-sm italic">Không tìm thấy kết quả cho "${query}"</p>
                    </div>`;
                return;
            }

            resultsDiv.innerHTML = `
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Kết quả tìm kiếm (${filtered.length})</p>
                <div class="space-y-3">
                    ${filtered.map(t => `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-50 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center font-bold text-[9px] ${t.type === 'income' ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600'}">
                                    ${t.type === 'income' ? 'THU' : 'CHI'}
                                </div>
                                <div>
                                    <p class="font-bold text-slate-800 text-xs">${t.note || 'Không có ghi chú'}</p>
                                    <div class="flex items-center gap-2 mt-0.5">
                                        <span class="text-[9px] font-bold text-indigo-500 bg-indigo-50 px-1.5 py-0.5 rounded uppercase">${t.category}</span>
                                        <span class="text-[9px] text-slate-400 font-medium">${t.date.split('-').reverse().join('/')}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <p class="font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-800'}">
                                    ${t.type === 'income' ? '+' : ''}${formatVND(t.amount)}
                                </p>
                                <button onclick="deleteTransaction('${t.id}')" class="text-slate-200 hover:text-red-500 transition-colors">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7a2 2 0 01-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            handleSearch();
        }

        function renderHomeRecent(monthStr) {
            const list = document.getElementById('homeRecentList');
            const filtered = state.transactions.filter(t => t.date.startsWith(monthStr)).sort((a,b) => b.date.localeCompare(a.date));
            
            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-center py-6 text-slate-400 text-xs italic">Chưa có giao dịch trong tháng này.</div>';
                return;
            }

            const days = {};
            filtered.forEach(t => {
                if (!days[t.date]) days[t.date] = { totalExp: 0, items: [] };
                if (t.type === 'expense') days[t.date].totalExp += t.amount;
                days[t.date].items.push(t);
            });

            list.innerHTML = Object.entries(days).map(([date, data]) => `
                <div class="space-y-2">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${date.split('-').reverse().join('/')}</span>
                        <span class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded-full">Chi: ${formatVND(data.totalExp)}</span>
                    </div>
                    <div class="space-y-2">
                        ${data.items.map(t => `
                            <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-50 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center font-bold text-[8px] ${t.type === 'income' ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600'}">
                                        ${t.type === 'income' ? 'THU' : 'CHI'}
                                    </div>
                                    <div>
                                        <p class="font-bold text-slate-800 text-[11px] leading-tight">${t.category}</p>
                                        <p class="text-[9px] text-slate-400 font-medium">${t.note || '---'}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="font-bold text-xs ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-800'}">
                                        ${t.type === 'income' ? '+' : ''}${formatVND(t.amount).replace('₫', '').trim()}
                                    </p>
                                    <button onclick="deleteTransaction('${t.id}')" class="text-slate-200 active:text-red-500">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7a2 2 0 01-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderHistoryTree() {
            const container = document.getElementById('historyTree');
            if (state.transactions.length === 0) {
                container.innerHTML = '<div class="text-center py-20 text-slate-400 italic">Trống</div>';
                return;
            }

            const months = {};
            state.transactions.forEach(t => {
                const mKey = t.date.substring(0, 7);
                if (!months[mKey]) months[mKey] = { income: 0, expense: 0, days: {} };
                if (t.type === 'income') months[mKey].income += t.amount;
                else months[mKey].expense += t.amount;

                if (!months[mKey].days[t.date]) months[mKey].days[t.date] = { expense: 0, items: [] };
                if (t.type === 'expense') months[mKey].days[t.date].expense += t.amount;
                months[mKey].days[t.date].items.push(t);
            });

            const sortedMonths = Object.keys(months).sort((a,b) => b.localeCompare(a));

            container.innerHTML = sortedMonths.map(mKey => {
                const mData = months[mKey];
                const [y, m] = mKey.split('-');
                return `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <button onclick="toggleCollapse('m-${mKey}')" class="w-full flex justify-between items-center p-4 bg-slate-50">
                            <div>
                                <p class="font-bold text-slate-800 text-sm">Tháng ${m}/${y}</p>
                                <div class="flex gap-3 mt-1">
                                    <span class="text-[9px] font-bold text-emerald-600">+ ${formatVND(mData.income)}</span>
                                    <span class="text-[9px] font-bold text-red-500">- ${formatVND(mData.expense)}</span>
                                </div>
                            </div>
                            <svg id="icon-m-${mKey}" class="rotate-icon w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div id="m-${mKey}" class="collapse-content border-t divide-y divide-slate-50">
                            ${Object.keys(mData.days).sort((a,b) => b.localeCompare(a)).map(dKey => {
                                const dData = mData.days[dKey];
                                return `
                                    <div class="p-0">
                                        <button onclick="toggleCollapse('d-${dKey}')" class="w-full flex justify-between items-center px-4 py-3 hover:bg-slate-50/50">
                                            <div class="flex items-center gap-3">
                                                <span class="text-xs font-bold text-slate-500">${dKey.split('-').reverse().join('/')}</span>
                                                <span class="text-[10px] font-bold text-red-400">Chi: ${formatVND(dData.expense)}</span>
                                            </div>
                                            <svg id="icon-d-${dKey}" class="rotate-icon w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                        </button>
                                        <div id="d-${dKey}" class="collapse-content px-4 pb-3 space-y-2">
                                            ${dData.items.map(t => `
                                                <div class="flex justify-between items-center p-2 bg-slate-50 rounded-xl">
                                                    <div class="flex items-center gap-3">
                                                        <div class="text-[8px] font-bold ${t.type === 'income' ? 'text-emerald-500' : 'text-red-500'}">${t.type === 'income' ? 'THU' : 'CHI'}</div>
                                                        <div>
                                                            <p class="text-[11px] font-bold text-slate-800">${t.category}</p>
                                                            <p class="text-[9px] text-slate-400 font-medium">${t.note || '---'}</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-xs font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-700'}">${formatVND(t.amount)}</span>
                                                        <button onclick="deleteTransaction('${t.id}')" class="text-slate-300 ml-1">
                                                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7a2 2 0 01-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCollapse(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                icon.classList.remove('active');
            } else {
                el.classList.add('active');
                icon.classList.add('active');
            }
        }

        function updateCategorySelect() {
            const typeInput = document.querySelector('input[name="type"]:checked');
            if(!typeInput) return;
            const type = typeInput.value;
            let optionsHtml = '';
            if (type === 'income') {
                optionsHtml = state.incomeCategories.map(c => `<option value="${c}">${c}</option>`).join('');
            } else {
                state.expenseGroups.forEach(g => {
                    optionsHtml += `<optgroup label="${g.name}">`;
                    g.categories.forEach(c => { optionsHtml += `<option value="${c}">${c}</option>`; });
                    optionsHtml += `</optgroup>`;
                });
            }
            document.getElementById('categoryContainer').innerHTML = `
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh mục</label>
                <select id="catInput" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 font-medium">
                    ${optionsHtml}
                </select>`;
        }

        function deleteTransaction(id) {
            openDialog('Xác nhận xóa', '<p class="text-xs text-center text-slate-500">Dữ liệu này sẽ được xóa vĩnh viễn.</p>', [
                { label: 'Hủy', class: 'flex-1 py-3 font-bold text-slate-400', onClick: closeDialog },
                { label: 'Xóa', class: 'flex-1 py-3 bg-red-600 text-white font-bold rounded-xl', onClick: () => {
                    state.transactions = state.transactions.filter(t => t.id !== id);
                    saveState();
                    if(document.getElementById('tab-history').classList.contains('active')) {
                        handleSearch();
                        renderHistoryTree();
                    }
                    closeDialog();
                }}
            ]);
        }

        function updateAnalysis() {
            const picker = document.getElementById('analysisMonthPicker');
            if (!picker.value) picker.value = new Date().toISOString().substring(0, 7);
            const [y, m] = picker.value.split('-');
            
            const groupTotals = {};
            state.expenseGroups.forEach(g => groupTotals[g.id] = { name: g.name, color: g.color, total: 0 });
            
            let totalExpense = 0;
            state.transactions.filter(t => t.type === 'expense' && t.date.startsWith(`${y}-${m}`)).forEach(t => {
                const group = state.expenseGroups.find(g => g.categories.includes(t.category)) || state.expenseGroups[state.expenseGroups.length-1];
                if (group && groupTotals[group.id]) {
                    groupTotals[group.id].total += t.amount;
                    totalExpense += t.amount;
                }
            });

            document.getElementById('chartTotalValue').textContent = formatVND(totalExpense);
            const activeGroups = Object.values(groupTotals).filter(g => g.total > 0);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(document.getElementById('financeChart'), {
                type: 'doughnut',
                data: {
                    labels: activeGroups.map(g => g.name),
                    datasets: [{ data: activeGroups.map(g => g.total), backgroundColor: activeGroups.map(g => g.color), borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } }
            });

            document.getElementById('groupSummaryList').innerHTML = activeGroups.map(g => `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full" style="background-color: ${g.color}"></div><span class="text-xs font-bold text-slate-700 uppercase">${g.name}</span></div>
                    <span class="text-xs font-bold text-slate-800">${formatVND(g.total)}</span>
                </div>
            `).join('');
        }

        function openDialog(title, bodyHtml, actions) {
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogBody').innerHTML = bodyHtml;
            const container = document.getElementById('dialogActions');
            container.innerHTML = '';
            if (!actions) actions = [{ label: 'Đóng', class: 'bg-slate-900 text-white w-full py-3 rounded-xl font-bold', onClick: closeDialog }];
            actions.forEach(act => {
                const btn = document.createElement('button');
                btn.className = act.class || 'flex-1 py-3 font-bold rounded-xl';
                btn.textContent = act.label;
                btn.onclick = act.onClick;
                container.appendChild(btn);
            });
            document.getElementById('dialogOverlay').classList.replace('hidden', 'flex');
        }

        function closeDialog() { document.getElementById('dialogOverlay').classList.replace('flex', 'hidden'); }

        function renderSettings() {
            document.getElementById('settingsIncomeList').innerHTML = state.incomeCategories.map(c => `<div class="bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full text-[10px] font-bold flex items-center gap-2 uppercase tracking-wide">${c}<button onclick="removeIncomeCategory('${c}')" class="text-emerald-300">×</button></div>`).join('');
            document.getElementById('settingsExpenseGroupsList').innerHTML = state.expenseGroups.map(g => `
                <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background-color: ${g.color}"></div><span class="text-[10px] font-bold text-slate-600 uppercase tracking-widest">${g.name}</span></div>
                        <button onclick="removeGroup('${g.id}')" class="text-[10px] text-red-400 font-bold uppercase">Xóa</button>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${g.categories.map(c => `<div class="bg-white px-2 py-1 rounded-lg text-[10px] font-medium border border-slate-200 flex items-center gap-2 shadow-sm">${c}<button onclick="removeCategoryFromGroup('${g.id}', '${c}')" class="text-slate-300">×</button></div>`).join('')}
                    </div>
                    <button onclick="openAddCategoryToGroupModal('${g.id}')" class="w-full py-2 bg-white rounded-lg border border-dashed border-slate-300 text-[10px] font-bold text-slate-400 uppercase">+ Thêm danh mục</button>
                </div>`).join('');
        }

        function openAddCategoryModal(type) { openDialog('Thêm danh mục', '<input id="modalInput" class="w-full bg-slate-100 rounded-xl p-3 text-sm" placeholder="Tên danh mục">', [{label:'Hủy', onClick:closeDialog},{label:'Thêm', class:'bg-indigo-600 text-white rounded-xl py-3 flex-1 font-bold', onClick:() => { const v = document.getElementById('modalInput').value.trim(); if(v){ state.incomeCategories.push(v); saveState(); renderSettings(); closeDialog(); }}}])}
        function removeIncomeCategory(n) { state.incomeCategories = state.incomeCategories.filter(c=>c!==n); saveState(); renderSettings(); }
        function removeGroup(id) { state.expenseGroups = state.expenseGroups.filter(g=>g.id!==id); saveState(); renderSettings(); }
        function removeCategoryFromGroup(gId, cN) { const g = state.expenseGroups.find(x=>x.id===gId); if(g) g.categories = g.categories.filter(c=>c!==cN); saveState(); renderSettings(); }
        function openAddCategoryToGroupModal(gId) { openDialog('Thêm vào nhóm', '<input id="catName" class="w-full bg-slate-100 rounded-xl p-3 text-sm" placeholder="Tên danh mục">', [{label:'Hủy', onClick:closeDialog},{label:'Lưu', class:'bg-indigo-600 text-white rounded-xl py-3 flex-1 font-bold', onClick:() => { const n = document.getElementById('catName').value.trim(); if(n){ const g = state.expenseGroups.find(x=>x.id===gId); if(g && !g.categories.includes(n)) g.categories.push(n); saveState(); renderSettings(); closeDialog(); }}}])}
        function openAddGroupModal() { openDialog('Nhóm mới', '<input id="groupName" class="w-full bg-slate-100 rounded-xl p-3 text-sm" placeholder="Tên nhóm">', [{label:'Hủy', onClick:closeDialog},{label:'Tạo', class:'bg-indigo-600 text-white rounded-xl py-3 flex-1 font-bold', onClick:() => { const n = document.getElementById('groupName').value.trim(); if(n){ state.expenseGroups.push({id:'g'+Date.now(), name:n, color:'#'+Math.floor(Math.random()*16777215).toString(16), categories:[]}); saveState(); renderSettings(); closeDialog(); }}}])}

        function exportData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `finance_pro_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    state = JSON.parse(ev.target.result);
                    saveState();
                    openDialog('Thành công', '<p class="text-xs text-center">Dữ liệu đã được cập nhật hoàn toàn.</p>');
                    location.reload();
                } catch (err) { openDialog('Lỗi', 'Tệp không hợp lệ'); }
            };
            if(e.target.files[0]) reader.readAsText(e.target.files[0]);
        }

        function clearAllData() { if(confirm("Bạn có chắc muốn xóa toàn bộ dữ liệu?")) { state = JSON.parse(JSON.stringify(DEFAULT_STATE)); saveState(); location.reload(); } }

        document.getElementById('transactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const rawAmount = document.getElementById('amountInput').value;
            const amount = parseFloat(rawAmount);
            if (isNaN(amount) || amount <= 0) {
                openDialog('Lỗi', 'Vui lòng nhập số tiền hợp lệ.');
                return;
            }
            
            const type = document.querySelector('input[name="type"]:checked').value;
            const category = document.getElementById('catInput').value;
            const note = document.getElementById('noteInput').value.trim();
            const date = document.getElementById('dateInput').value;
            
            state.transactions.push({ id: 't'+Date.now(), type, amount, category, note, date });
            saveState();
            
            // Reset form
            document.getElementById('amountDisplayInput').value = '';
            document.getElementById('amountInput').value = '';
            document.getElementById('noteInput').value = '';
            openDialog('Đã lưu', '<p class="text-xs text-center">Ghi chép thành công.</p>');
        });

        document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
        loadState();
    </script>
</body>
</html>

